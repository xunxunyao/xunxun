<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>xunxun&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="javascript">
<meta property="og:type" content="website">
<meta property="og:title" content="xunxun&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="xunxun&#39;s Blog">
<meta property="og:description" content="javascript">
<meta property="og:locale" content="zh-cn">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="xunxun&#39;s Blog">
<meta name="twitter:description" content="javascript">
  
    <link rel="alternate" href="/atom.xml" title="xunxun&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xunxun&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-compileTemplate" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/16/compileTemplate/" class="article-date">
  <time datetime="2019-12-16T03:38:27.000Z" itemprop="datePublished">2019-12-16</time>
</a>
    
</span>
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/16/compileTemplate/">简易模板编译工具</a>
    </h1>
  

      </header>
      <div id="busuanzi_container_page_pv" style="left: 20px;display: inline;color: #ccc;font-size: 12px;position: relative;top: 6px;">
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>项目中有一个需求是这样的：有一个轮播列表组件，提供工具栏，可以让用户通过配置来调整列表颜色、边框、大小和动画等各项参数。每次保存配置的时候重新渲染，刷新列表样式。所以这里列表的html和css将会有很多从配置文件获取而来的变量，而不是像以前渲染出来的模板一样固定数值。<br>利用ES6的<code>template string</code>可以很容易的做到，在js中动态渲染html：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> list = [</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">'四毛'</span>,</span><br><span class="line">        description: <span class="string">'可爱'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        name: <span class="string">'八毛'</span>,</span><br><span class="line">        description: <span class="string">'也可爱'</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="keyword">let</span> items = <span class="string">``</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> i <span class="keyword">of</span> list) &#123;</span><br><span class="line">    items += <span class="string">`&lt;li&gt;<span class="subst">$&#123;i.name&#125;</span>:<span class="subst">$&#123;i.description&#125;</span>&lt;/li&gt;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> content = <span class="string">`</span></span><br><span class="line"><span class="string">    &lt;ul&gt;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;items&#125;</span></span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line">$(<span class="keyword">this</span>.$container).html(content)</span><br></pre></td></tr></table></figure></p>
<p>但是这样写结构样式和js逻辑没有分离，增加了编码和维护成本。希望的是可以把html和css放在模板中，编译成字符串的形式，给js使用。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>开始之前，我们选定轻便简单的<code>gulp</code>来构建文件。</p>
<p>首先，我们想要拥有单独的html模板文件，并且做到结构和样式分离。简单的方法就是在<code>&lt;style&gt;</code>标签里写样式，再用 <a href="https://www.npmjs.com/package/gulp-inline-css" target="_blank" rel="noopener">gulp-inline-css</a>     将css处理成内联样式。</p>
<p>第二步，带有样式的html模板文件要怎么变成js字符串呢？可以利用 <a href="https://www.npmjs.com/package/gulp-html-to-js" target="_blank" rel="noopener">gulp-html-to-js</a> 将html处理成js。这个插件可以一同处理多个html模板，最终生成的js中，是这样的形式：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"><span class="built_in">module</span>.exports[<span class="string">'index.html'</span>] = <span class="string">'&lt;p&gt;Hello world!&lt;/p&gt;'</span></span><br></pre></td></tr></table></figure></p>
<p>这样，在js中就能导入相应的模板字符串。<br>以上两步，gulpfile.js只需要这样处理：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inlineCss = <span class="built_in">require</span>(<span class="string">'gulp-inline-css'</span>)</span><br><span class="line"><span class="keyword">const</span> html2js = <span class="built_in">require</span>(<span class="string">'gulp-html-to-js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">templates</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'src/templates/*.html'</span>)</span><br><span class="line">        .pipe(inlineCss())</span><br><span class="line">        .pipe(html2js(&#123;<span class="attr">concat</span>: <span class="string">'templates.js'</span>&#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./'</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.templates = templates</span><br></pre></td></tr></table></figure></p>
<p>第三步，处理变量。以上的模板处理出来是一个字符串，但是我们需要利用配置文件动态改变样式，直接字符串模板显然不符合需求。我们可以这样做：将<code>module.exports</code>出来的内容处理成一个<code>function</code>，参数是配置文件数据，返回值是模板字符串和变量的拼接。形如：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">config, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;p style="color:'</span> +  config.color  + <span class="string">'"&gt;'</span> + data.value + <span class="string">'&lt;/p&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样，可以将带有变量的html抽离出去，构建成js，再动态<code>import</code>，做到结构、样式、逻辑分离。现在最重要的一个问题，就是怎么模板变成拼接的字符串。</p>
<h3 id="处理变量"><a href="#处理变量" class="headerlink" title="处理变量"></a>处理变量</h3><p>通过 <a href="https://www.npmjs.com/package/gulp-html-to-js" target="_blank" rel="noopener">gulp-html-to-js</a> 处理之后的文件， 我们通过 <a href="https://www.npmjs.com/package/through2" target="_blank" rel="noopener">through2</a> 拿到文件流。将文件流转成字符串，之后就可以对字符串操作。提取<code>module.exports</code>出来的内容，用正则将原本的模板转化成<code>function</code>。利用 <a href="https://www.npmjs.com/package/through2" target="_blank" rel="noopener">through2</a> 可以提取文件的文本内容，处理完我们想要的操作之后，记得字符串转回去流。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">templates</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'src/templates/*.html'</span>)</span><br><span class="line">        .pipe(inlineCss())</span><br><span class="line">        .pipe(html2js(&#123;<span class="attr">concat</span>: <span class="string">'templates.js'</span>&#125;))</span><br><span class="line">        .pipe(through.obj(<span class="function"><span class="keyword">function</span> (<span class="params">file, encode, cb</span>) </span>&#123;</span><br><span class="line">            <span class="comment">//  流转化成字符串</span></span><br><span class="line">            <span class="keyword">let</span> result = file.contents.toString()</span><br><span class="line">            <span class="comment">// 正则拿到“module.exports['index.html'] = '内容'” 导出的内容</span></span><br><span class="line">            result = result.replace(<span class="regexp">/(module.exports\['.+?'\] = )('[\s\S]*?(?&lt;!\\)')/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">match, p1, p2</span>)</span>&#123;</span><br><span class="line">               <span class="comment">// 将原来的字符串模板处理成方法，parse函数下文解释</span></span><br><span class="line">               <span class="comment">// return p1 + parse(p2)</span></span><br><span class="line">            &#125;)</span><br><span class="line">            file.contents = <span class="keyword">new</span> Buffer(result) <span class="comment">// 字符串转成流</span></span><br><span class="line">            <span class="comment">// 提供给下个pipe使用</span></span><br><span class="line">            <span class="keyword">this</span>.push(file)</span><br><span class="line">            cb()</span><br><span class="line">         &#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./'</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在模板中，需要动态变更的变量，设置一个插值语法，比如常用的<code>&lt;%= %&gt;</code>：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span> <span class="attr">data.value</span> %&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>我们要将这个模板变成：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">config, data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'&lt;p&gt;'</span> + data.value + <span class="string">'&lt;/p&gt;'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以使用正则替换：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> evalExpr = <span class="regexp">/&lt;%=(.+?)%&gt;/g</span></span><br><span class="line">    content = content</span><br><span class="line">        .replace(evalExpr, <span class="string">"' + $1 +'"</span> ))</span><br><span class="line">    <span class="keyword">let</span> compile = <span class="string">`function (config, data) &#123;</span></span><br><span class="line"><span class="string">        return '<span class="subst">$&#123;content&#125;</span>'</span></span><br><span class="line"><span class="string">        &#125;`</span></span><br><span class="line">    <span class="keyword">return</span> compile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以得到：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"function (config, data) &#123;</span></span><br><span class="line"><span class="string">      return '&lt;p&gt;' +  data.value  +'&lt;p&gt;'</span></span><br><span class="line"><span class="string">  &#125;"</span></span><br></pre></td></tr></table></figure></p>
<p>我们还希望模板能处理简单的循环或者是判断语句，这里用<code>&lt;% %&gt;</code>来放置js语句。可以看到整个编译函数的核心就是将插值的变量/语句提取出来，与其他的进行字符串拼接。这里参考阮一峰老师提到过的<a href="https://es6.ruanyifeng.com/#docs/string#%E5%AE%9E%E4%BE%8B%EF%BC%9A%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91" target="_blank" rel="noopener">编译函数</a> 来优化一下代码。<br>写一个拼接函数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> output = <span class="string">''</span></span><br><span class="line"><span class="keyword">const</span> echo = <span class="function"><span class="keyword">function</span> (<span class="params">html</span>) </span>&#123;</span><br><span class="line">   output += html</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上文中正则插值替换，就变成<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo(<span class="string">'&lt;p&gt;'</span> )</span><br><span class="line">echo（ data.value）</span><br><span class="line">echo（ <span class="string">'&lt;p&gt;'</span>）</span><br><span class="line"><span class="comment">//正则</span></span><br><span class="line">content = content.replace(evalExpr, <span class="string">`')\n echo(<span class="subst">$&#123;expr&#125;</span>)\n echo('`</span> ))</span><br></pre></td></tr></table></figure></p>
<p>对于js语句也是相同的处理方法。<br>有一点需要注意的是，我们生成的字符串都是用单引号，如果在表达式中需要用到字符串（也会有一个单引号），会被加上转义符，这里还要将转义符去掉。<br>对于css的变量，如果使用 <code>&lt;</code> 的插值，css处理的插件会报错。这里我们使用以下符号来进行插值<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`&#123;%= %&#125;`</span></span><br></pre></td></tr></table></figure></p>
<p>在内联处理之后，再转化成 <code>&lt;</code>，就可以不用另外对css进行处理了。<br>以下就是完整的编译函数。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse</span> (<span class="params">content</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cssExpr = <span class="regexp">/\\'\&#123;(%[\s\S]+?%)\&#125;\\'/g</span></span><br><span class="line">    <span class="keyword">const</span> evalExpr = <span class="regexp">/&lt;%=(.+?)%&gt;/g</span></span><br><span class="line">    <span class="keyword">const</span> expr = <span class="regexp">/&lt;%([\s\S]+?)%&gt;/g</span></span><br><span class="line">    content = content</span><br><span class="line">        .replace(cssExpr, <span class="string">"&lt;$1&gt;"</span>)</span><br><span class="line">        .replace(evalExpr, <span class="function"><span class="keyword">function</span>(<span class="params">match, p</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> expr = p.replace(<span class="regexp">/\\'/g</span>, <span class="string">"'"</span>) <span class="comment">// 处理被转义的单引号</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">`')\n echo(<span class="subst">$&#123;expr&#125;</span>)\n echo('`</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .replace(expr, <span class="function"><span class="keyword">function</span>(<span class="params">match, p</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">const</span> expr = p.replace(<span class="regexp">/\\'/g</span>, <span class="string">"'"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">`')\n <span class="subst">$&#123;expr&#125;</span>\n echo('`</span></span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">let</span> compile = <span class="string">`function (config, data) &#123;</span></span><br><span class="line"><span class="string">        let output = ''</span></span><br><span class="line"><span class="string">        const echo = function (html) &#123;</span></span><br><span class="line"><span class="string">             output += html</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        echo(<span class="subst">$&#123;content&#125;</span>)</span></span><br><span class="line"><span class="string">        return output</span></span><br><span class="line"><span class="string">        &#125;`</span></span><br><span class="line">    <span class="keyword">return</span> compile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这就完成了，我们可以这样书写html和css</p>
<p>content.html:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;% for (let count = 0; count &lt; config.score.number; count++)&#123;%&gt;</span><br><span class="line">    &lt;% if (count &lt; 10) &#123;%&gt;</span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;%= config.score.highlight %&gt;"</span> <span class="attr">class</span>=<span class="string">"score-img"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">%</span> &#125; <span class="attr">else</span> &#123;%&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&lt;%= config.score.defaultIcon %&gt;"</span> <span class="attr">class</span>=<span class="string">"score-img"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%</span> &#125;%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125;%&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">.origin-list-flip-with-score .item-number &#123;</span></span><br><span class="line"><span class="undefined">    width: '&#123;%= config.orderNumber.width %&#125;'px;</span></span><br><span class="line"><span class="undefined">    margin: '&#123;%= config.nameArea.position === 'left' ? '0 5px 0 0' : '0 0 0 5px' %&#125;';</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在js中这样使用<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> html <span class="keyword">from</span> <span class="string">'./templates.js'</span></span><br><span class="line">$(<span class="keyword">this</span>.$container).html(html[<span class="string">'content.html'</span>](<span class="keyword">this</span>.style, &#123;</span><br><span class="line">    listData: <span class="keyword">this</span>.listData</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/16/compileTemplate/" data-id="ck47w1tt00002dl7vvy4feet1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-miniWebpack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/miniWebpack/" class="article-date">
  <time datetime="2019-07-17T15:56:56.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
</span>
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/17/miniWebpack/">webpack 打包过程</a>
    </h1>
  

      </header>
      <div id="busuanzi_container_page_pv" style="left: 20px;display: inline;color: #ccc;font-size: 12px;position: relative;top: 6px;">
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文参考<code>webpack</code>创始人 Tobias Koppers 的视频 <a href="https://www.youtube.com/watch?v=UNMkLHzofQI" target="_blank" rel="noopener">Webpack founder Tobias Koppers demos bundling live by hand</a>,梳理<code>webpack</code>打包过程。</p>
<h1 id="手动打包文件"><a href="#手动打包文件" class="headerlink" title="手动打包文件"></a>手动打包文件</h1><h2 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h2><p>我们准备一个极简单的项目来进行打包，目录结构和内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-- src</span><br><span class="line">| +-- big.js</span><br><span class="line">| +-- helloWorld.js</span><br><span class="line">| +-- index.js</span><br><span class="line">| +-- lazy.js</span><br></pre></td></tr></table></figure></p>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">'./helloWorld'</span></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "async" */</span> <span class="string">'./lazy'</span>).then(<span class="function">(<span class="params">&#123; <span class="keyword">default</span>: lazy &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">node.innerHTML = helloWorld + lazy</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(node)</span><br></pre></td></tr></table></figure></p>
<p>helloWorld.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"><span class="keyword">const</span> helloWorld = big(<span class="string">'hello world!'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> helloWorld</span><br></pre></td></tr></table></figure></p>
<p>big.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (val) =&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>lazy.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"><span class="keyword">const</span> lazy = big(<span class="string">"lazy loaded!"</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> lazy</span><br></pre></td></tr></table></figure></p>
<p>我们先来看下webpack打包之后的结果，省略了一些代码，但是大体可以看到，所有分散的文件最终变成一个立即执行函数，参数是文件（模块）队列数组。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/******/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;<span class="comment">// webpackBootstrap</span></span><br><span class="line">   <span class="comment">/******/</span> <span class="comment">// ...</span></span><br><span class="line"> <span class="comment">/******/</span> &#125;)(&#123;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/big.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;&#125;),</span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/index.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="comment">/***/</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/******/</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们的目标是通过人工打包的方式生成这样一个立即执行函数，通过一定的串联逻辑，将所有的模块整合到一起。</p>
<h2 id="模块划分"><a href="#模块划分" class="headerlink" title="模块划分"></a>模块划分</h2><p>可以看到项目模块之间有这样的引用关系，入口文件引入了<code>helloWorld</code>和<code>lazy</code>，<code>helloWorld</code>和<code>lazy</code>分别又引入了<code>big</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* src/index.js (ESM)</span><br><span class="line">    #  ./helloWorld</span><br><span class="line">    # (async) ./lazy</span><br><span class="line">    -  src/helloWorld.js</span><br><span class="line">    -  (async) src/lazy.js</span><br><span class="line">* src/helloWorld.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br><span class="line">* src/big.js</span><br><span class="line">* src/lazy.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br></pre></td></tr></table></figure>
<p> 打包之后将生成两个文件，一个主文件main.js，一个是动态引入的async.js。其中，main是async的父文件，main中有的模块，asycn可以不引入。main文件里面已经包含了<code>src/big.js</code>，这里进行优化，打包后的<code>async.js</code>不需要包含<code>src/big.js</code><br> 如下图所示：<br> <img src="miniWebpack/5b4526ed.png" alt=""><br><img src="/2019/07/17/miniWebpack/5b4526ed.png"></p>
<p> main.js<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- src/index.js</span><br><span class="line">- src/helloWorld.js</span><br><span class="line">- src/big.js</span><br></pre></td></tr></table></figure></p>
<p> async.js (parent:main)<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- src/lazy.js</span><br><span class="line">- src/big.js （ in parent）---delete</span><br></pre></td></tr></table></figure></p>
<p> 现在划分一下模块，可以看到入口文件–<code>index.js</code>，我们将它<code>import</code>的文件直接串联当成第一个模块。这里只有引入一个模块<code>helloWorld</code>（lazy是打包进去<code>async.js</code>暂不考虑）。由此可以划分成三个模块，我们手动为每个模块赋予一个<code>id</code>（中括号中的数字）。<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* [0]src/index.js (ESM) + 1modules</span><br><span class="line">    #  ./helloWorld</span><br><span class="line">    # (async) ./lazy</span><br><span class="line">    -  src/helloWorld.js</span><br><span class="line">    -  (async) src/lazy.js</span><br><span class="line">    -  src/big.js</span><br><span class="line">* [1]src/big.js</span><br><span class="line">* [2]src/lazy.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br></pre></td></tr></table></figure></p>
<h2 id="import和export"><a href="#import和export" class="headerlink" title="import和export"></a>import和export</h2><p> 我们知道<code>webpack</code>把分散的代码通过<code>import</code>和<code>export</code>串成一个立即执行函数（IIFE），参数是模块对象数组。<br> 其中模块对象是一个这样的结构：<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  [moduleId]: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 模块代码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在来处理一下每个文件的<code>import</code>和<code>export</code> 。</p>
<p>对于每一个模块，要保证有独立的作用域，用一个<code>funtion</code>去包裹。并且传入两个参数，用来实现<code>import</code>和<code>export</code>的功能。<br> index.js + 1 modules(hellowWorld.js)<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> helloWorld = X.default(<span class="string">'hello world!'</span>)</span><br><span class="line">  <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">  node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">  <span class="comment">// 先看普通的import</span></span><br><span class="line">  <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;) =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   node.innerHTML = helloWorld + lazy</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>big.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="模拟import"><a href="#模拟import" class="headerlink" title="模拟import"></a>模拟import</h3><p> import的功能就是：<br> 1.执行目标模块的代码;<br> 2.导出目标模块的<code>export</code>内容给外部使用。<br> 如下<code>__require__</code>函数的实现，<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__require__</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置一个缓存，有的话直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(cache[id]) <span class="keyword">return</span> cache[id].exports</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">        exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 1、执行当前模块的内容，这个modules[id]就是我们刚才对每个模块封装的那个方法</span></span><br><span class="line">    modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>)</span><br><span class="line">    cache[id] = <span class="built_in">module</span></span><br><span class="line">    <span class="comment">// 2、导出当前模块的export内容给外部使用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">            exports: []</span><br><span class="line">        &#125;</span><br><span class="line">        modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">    &#125;</span><br><span class="line">    __require__(<span class="number">0</span>)</span><br><span class="line">    &#125;)(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">const</span> helloWorld = X.default(<span class="string">'hello world!'</span>)</span><br><span class="line">                <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">                node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">                <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;)   =&gt; &#123;</span></span><br><span class="line">                <span class="comment">// node.innerHTML = helloWorld + lazy</span></span><br><span class="line">                <span class="comment">// &#125;</span></span><br><span class="line">                <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">              &#125;),</span><br><span class="line">        <span class="number">1</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">                exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>在index.html上引入这个文件，打开就能看到结果了。至此，我们完成了最基本的手动打包流程。</p>
<h3 id="懒加载模块"><a href="#懒加载模块" class="headerlink" title="懒加载模块"></a>懒加载模块</h3><p>现在还剩下对<code>lazy.js</code>的打包，它是作为一个单独的文件，按需引入的。我们希望使用的时候是这样的，加载完模块，然后进行require：<br>index.js (bundled)<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="comment">// node.innerHTML = helloWorld + lazy</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">__require__.loadChunk(<span class="number">0</span>)</span><br><span class="line">    .then(__require__.bind(<span class="literal">null</span>, <span class="number">3</span>))</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span>(<span class="params">Y</span>)</span>&#123;</span><br><span class="line">            node.innerHTML = helloWorld + Y.default</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure></p>
<p>请求一个文件地址，得到文件中的数据，这个过程用类似<code>jsonp</code>的方式来实现。<br><img src="miniWebpack/2019-07-28-00-18-44.png" alt=""><br><img src="/2019/07/17/miniWebpack/2019-07-28-00-18-44.png"></p>
<p>首先是下载文件，这个过程是异步的，要用一个<code>promise</code>来封装。下载完成，还需要解析出数据才能执行下一步。所以，<code>promise</code>的回调函数<code>resolve</code>下载完成先放在一个全局变量<code>chunkResolves</code>当中，等解析出数据之后再调用它。</p>
<p>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个模块下载(promise)完成对应的resolve</span></span><br><span class="line"><span class="keyword">let</span> chunkResolves = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">__require__.loadChunk = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        chunkResolves[chunkId] = resolve</span><br><span class="line">        <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">        script.src = <span class="string">'src/'</span> + &#123;<span class="number">0</span>: <span class="string">'async'</span>&#125;[chunkId]+ <span class="string">'.js'</span></span><br><span class="line">        <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据<code>jsonp</code>的原理，下载下来的模块对象需要用一个<code>callback</code>（这里是<code>requireJsonp</code>）包裹，变成一个可执行的脚本，下载完成之后在本地执行这个<code>callback</code>才能解析出模块对象。所以手动对异步的模块进行一个封装：<br>async.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.requireJsonp( <span class="number">0</span>, &#123;</span><br><span class="line">    <span class="number">3</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">const</span> lazy = X.default(<span class="string">"lazy loaded!"</span>)</span><br><span class="line">        exports.default = lazy</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>并且我们应提前声明好<code>window.requireJsonp</code>这个回调函数。我们把下载得到的动态模块对象添加到立即执行函数参数的个模块对象，就回到了普通的模块打包的情况，这时候解析完成，执行<code>promise</code>的<code>resolve</code>，算是整个异步加载的过程结束。<br>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 每个模块下载(promise)完成对应的resolve</span></span><br><span class="line">   <span class="keyword">let</span> chunkResolves = &#123;&#125;;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">window</span>.requireJsonp = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId, newModules</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> id <span class="keyword">in</span> newModules) &#123;</span><br><span class="line">            modules[id] = newModules[id]</span><br><span class="line">            chunkResolves[chunkId]();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __require__(<span class="number">0</span>)</span><br><span class="line">    &#125;)(&#123;</span><br><span class="line">        <span class="comment">//...模块对象</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样，我们就完成了人工打包一个项目的简单流程。接下来看要怎么用代码来实现自动打包。</p>
<h1 id="自动打包"><a href="#自动打包" class="headerlink" title="自动打包"></a>自动打包</h1><p>我们参考开源项目<a href="https://github.com/ronami/minipack" target="_blank" rel="noopener">minipack</a>，来看看要怎么实现一个简易的打包工具。<br>先不看详细的细节，我们主要的步骤就是:<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析模块</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span>(<span class="params">filename</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 生成依赖图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span>(<span class="params">entry</span>)</span>&#123;&#125;</span><br><span class="line"><span class="comment">// 打包</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span>(<span class="params">graph</span>)</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> graph = createGraph(<span class="string">'./src/index.js'</span>)</span><br><span class="line"><span class="keyword">const</span> result = bundle(graph)</span><br></pre></td></tr></table></figure></p>
<p> 所依赖的工具</p>
<ul>
<li>abylon：js解析器，将文本代码转化成AST（语法树）</li>
<li>babel-travse：遍历AST寻找依赖关系</li>
<li>babel-core的transformFromAst：将AST代码转化成浏览器所能识别的代码(ES5)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> babylon = <span class="built_in">require</span>(<span class="string">'babylon'</span>); <span class="comment">// 将文件转化成AST</span></span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'babel-traverse'</span>).default; <span class="comment">// 寻找依赖关系</span></span><br><span class="line"><span class="keyword">const</span> &#123;transformFromAst&#125; = <span class="built_in">require</span>(<span class="string">'babel-core'</span>); <span class="comment">// 将 AST 转化成 ES5</span></span><br></pre></td></tr></table></figure>
<p> 主要就是把文本文件转化成语法树，拿到<code>import</code>和<code>export</code>知道模块之间的依赖关系，再把语法树转换成ES5。</p>
<p>可以了解一下语法树,如下图所示，可以拿到每句代码对应的信息。<br><img src="miniWebpack/2019-07-28-01-23-40.png" alt=""><br><img src="/2019/07/17/miniWebpack/2019-07-28-01-23-40.png"></p>
<h2 id="解析单个文件"><a href="#解析单个文件" class="headerlink" title="解析单个文件"></a>解析单个文件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 读一个文件，得到一个文件内容的字符串</span></span><br><span class="line">  <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">'utf-8'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 我们通过 babylon 这个 javascript 解析器来理解 import 进来的字符串</span></span><br><span class="line">  <span class="keyword">const</span> ast = babylon.parse(content, &#123;</span><br><span class="line">    sourceType: <span class="string">'module'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 该模块所依赖的模块的相对路径放在这个 dependencies 数组</span></span><br><span class="line">  <span class="keyword">const</span> dependencies = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// import声明</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    <span class="comment">// es6 的模块是静态的，不能导入一个变量或者有条件的导入另一个模块</span></span><br><span class="line">    ImportDeclaration: <span class="function">(<span class="params">&#123;node&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 所依赖的模块的路径</span></span><br><span class="line">      dependencies.push(node.source.value);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递增设置模块ID</span></span><br><span class="line">  <span class="keyword">const</span> id = ID++;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AST -&gt; ES5</span></span><br><span class="line">  <span class="keyword">const</span> &#123;code&#125; = transformFromAst(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">    presets: [<span class="string">'env'</span>],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回模块的信息</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    id,</span><br><span class="line">    filename,</span><br><span class="line">    dependencies,</span><br><span class="line">    code,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index文件解析后输出如下内容<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">'./helloWorld'</span></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(node)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">  filename: <span class="string">'./src/index.js'</span>,</span><br><span class="line">  dependencies: [ <span class="string">'./helloWorld.js'</span> ],</span><br><span class="line">  code: <span class="string">'"use strict";\n\n</span></span><br><span class="line"><span class="string">    var _helloWorld = require("./helloWorld.js");\n\n</span></span><br><span class="line"><span class="string">    var _helloWorld2 = _interopRequireDefault(_helloWorld);\n\n</span></span><br><span class="line"><span class="string">    function  _interopRequireDefault(obj) &#123; </span></span><br><span class="line"><span class="string">        return obj &amp;&amp; obj.__esModule ? obj : &#123;</span></span><br><span class="line"><span class="string">        default: obj &#125;; &#125;\n\n</span></span><br><span class="line"><span class="string">    var node = document.createElement("div");\nn</span></span><br><span class="line"><span class="string">    ode.innerHTML = _helloWorld2.default + \'loading...\';\n\n</span></span><br><span class="line"><span class="string">    document.body.appendChild(node);'</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="生成依赖图"><a href="#生成依赖图" class="headerlink" title="生成依赖图"></a>生成依赖图</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们需要知道单个模块的依赖，然后从入口文件开始，提取依赖图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 从第一个文件开始,首先解析index文件</span></span><br><span class="line">  <span class="keyword">const</span> mainAsset = createAsset(entry);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义一个依赖队列，一开始的时候只有入口文件</span></span><br><span class="line">  <span class="keyword">const</span> queue = [mainAsset];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 queue，广度优先</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> queue) &#123;</span><br><span class="line">    asset.mapping = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dirname = path.dirname(asset.filename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历依赖数组，解析每一个依赖模块</span></span><br><span class="line">    asset.dependencies.forEach(<span class="function"><span class="params">relativePath</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> absolutePath = path.join(dirname, relativePath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析</span></span><br><span class="line">      <span class="keyword">const</span> child = createAsset(absolutePath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 子模块`路径-id`map</span></span><br><span class="line">      asset.mapping[relativePath] = child.id;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 每一个子模块加入依赖图队列，进行遍历</span></span><br><span class="line">      queue.push(child);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>输出的依赖图长这样：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">    filename: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    dependencies: [ <span class="string">'./helloWorld.js'</span> ],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nvar _helloWorld = require("./helloWorld.js");\n\nvar _helloWorld2 = _interopRequireDefault(_helloWorld);\n\nfunction _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;\n\nvar node = document.createElement("div");\nnode.innerHTML = _helloWorld2.default + \'loading...\';\n// import(/* webpackChunkName: "async" */ \'./lazy\').then((&#123; default: lazy &#125;) =&gt; &#123;\n//   node.innerHTML = helloWorld + lazy\n// &#125;)\ndocument.body.appendChild(node);'</span>,</span><br><span class="line">    mapping: &#123; <span class="string">'./helloWorld.js'</span>: <span class="number">1</span> &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    filename: <span class="string">'src\\helloWorld.js'</span>,</span><br><span class="line">    dependencies: [ <span class="string">'./big.js'</span> ],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nObject.defineProperty(exports, "__esModule", &#123;\n  value: true\n&#125;);\n\nvar _big = require("./big.js");\n\nvar _big2 = _interopRequireDefault(_big);\n\nfunction _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;\n\nvar helloWorld = (0, _big2.default)(\'hello world!\');\nexports.default = helloWorld;'</span>,</span><br><span class="line">    mapping: &#123; <span class="string">'./big.js'</span>: <span class="number">2</span> &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    filename: <span class="string">'src\\big.js'</span>,</span><br><span class="line">    dependencies: [],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nObject.defineProperty(exports, "__esModule", &#123;\n  value: true\n&#125;);\n\nexports.default = function (val) &#123;\n  return val &amp;&amp; val.toUpperCase();\n&#125;;'</span>,</span><br><span class="line">    mapping: &#123;&#125;</span><br><span class="line">  &#125; ]</span><br></pre></td></tr></table></figure></p>
<h2 id="构造自执行函数和参数modules"><a href="#构造自执行函数和参数modules" class="headerlink" title="构造自执行函数和参数modules"></a>构造自执行函数和参数<code>modules</code></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最终我们要生成一个自执行函数，参数是模块依赖图</span></span><br><span class="line"><span class="comment">// (function() &#123;&#125;)()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span>(<span class="params">graph</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> modules = <span class="string">''</span>;</span><br><span class="line">  graph.forEach(<span class="function"><span class="params">mod</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 利用 createAsset 解析的时候，我们是把 import 转化成 commonJs 的 require</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模块`id-路径`的map，因为我们转化之后的代码的require是使用相对路径.写一个map，拿到模块id的时候可以知道该模块对应的路径</span></span><br><span class="line">    <span class="comment">// &#123; './relative/path': 1 &#125;.</span></span><br><span class="line"></span><br><span class="line">    modules += <span class="string">`<span class="subst">$&#123;mod.id&#125;</span>: [</span></span><br><span class="line"><span class="string">      function (require, module, exports) &#123;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;mod.code&#125;</span></span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(mod.mapping)&#125;</span>,</span></span><br><span class="line"><span class="string">    ],`</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="string">`</span></span><br><span class="line"><span class="string">    (function(modules) &#123;</span></span><br><span class="line"><span class="string">      function require(id) &#123;</span></span><br><span class="line"><span class="string">        const [fn, mapping] = modules[id];</span></span><br><span class="line"><span class="string">        function localRequire(name) &#123;</span></span><br><span class="line"><span class="string">          return require(mapping[name]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        const module = &#123; exports : &#123;&#125; &#125;;</span></span><br><span class="line"><span class="string">        fn(localRequire, module, module.exports);</span></span><br><span class="line"><span class="string">        return module.exports;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      require(0);</span></span><br><span class="line"><span class="string">    &#125;)(&#123;<span class="subst">$&#123;modules&#125;</span>&#125;)</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的模块对象参数跟我们第一部分手动打包的模块对像是一样的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _helloWorld = <span class="built_in">require</span>(<span class="string">"./helloWorld.js"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _helloWorld2 = _interopRequireDefault(_helloWorld);</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">        node.innerHTML = _helloWorld2.default + <span class="string">'loading...'</span>;</span><br><span class="line">        <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default:</span></span><br><span class="line">        lazy &#125;) =&gt; &#123;</span><br><span class="line">        <span class="comment">//   node.innerHTML = helloWorld + lazy</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(node);</span><br><span class="line">              &#125;,</span><br><span class="line">     &#123;<span class="string">"./helloWorld.js"</span>:<span class="number">1</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line"><span class="number">1</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">          value: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _big = <span class="built_in">require</span>(<span class="string">"./big.js"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _big2 = _interopRequireDefault(_big);</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> helloWorld = (<span class="number">0</span>, _big2.default)(<span class="string">'hello world!'</span>);</span><br><span class="line">        exports.default = helloWorld;</span><br><span class="line">              &#125;,</span><br><span class="line">     &#123;<span class="string">"./big.js"</span>:<span class="number">2</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line"><span class="number">2</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">          value: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        exports.default = <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> val &amp;&amp; val.toUpperCase();</span><br><span class="line">        &#125;;</span><br><span class="line">              &#125;,</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></p>
<p>至此我们完成了一个简易的模块打包器。</p>
<p>参考文献：<br><a href="https://www.youtube.com/watch?v=UNMkLHzofQI" target="_blank" rel="noopener">Webpack founder Tobias Koppers demos bundling live by hand</a><br>github 项目 <a href="https://github.com/ronami/minipack" target="_blank" rel="noopener">minipack</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/17/miniWebpack/" data-id="ck47vuvzz0001dl7vldh85gwr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-vscodeCfg" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/05/12/vscodeCfg/" class="article-date">
  <time datetime="2019-05-12T04:05:48.000Z" itemprop="datePublished">2019-05-12</time>
</a>
    
</span>
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/05/12/vscodeCfg/">Vue 项目的 VS Code 配置</a>
    </h1>
  

      </header>
      <div id="busuanzi_container_page_pv" style="left: 20px;display: inline;color: #ccc;font-size: 12px;position: relative;top: 6px;">
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>打开一个Vue项目，VS Code就会推荐我们安装功能强大的Vetur。这个插件支持语法高亮，安装重载之后，代码瞬间就漂亮起来了。</p>
<p>按照<a href="https://vuejs.github.io/vetur/setup.html" target="_blank" rel="noopener">Vetur</a>官网的介绍(具体内容参考官网)，根据项目需要选择安装<code>sass</code>等插件，安装<a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="noopener">ESLint</a>代码检查插件。然后修改VS Code的<code>settings.js</code>，<code>eslint.validate</code>配置加上<code>vue</code>。最后添加<code>jsconfig.json</code>来帮助VS Code识别vue文件和其他<code>import</code>的文件。</p>
<h3 id="自动import组件"><a href="#自动import组件" class="headerlink" title="自动import组件"></a>自动<code>import</code>组件</h3><p>在根目录添加<code>jsconfig.json</code>，由于我的项目中使用了webpack的<code>resolve.alias</code>，将目录<code>src</code>设置别名作<code>@</code>，这里应该加上相应的映射。</p>
<p>jsconfig.json<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"include"</span>: [</span><br><span class="line">        <span class="string">"./src/**/*"</span></span><br><span class="line"> ],</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">      <span class="attr">"baseUrl"</span>: <span class="string">"."</span>,</span><br><span class="line">      <span class="attr">"paths"</span>: &#123;</span><br><span class="line">          <span class="attr">"@/*"</span>: [</span><br><span class="line">              <span class="string">"src/*"</span></span><br><span class="line">          ]</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们重启VS Code来测试一下，现在有以下的目录结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+-- components</span><br><span class="line">|   +-- VTestA.vue</span><br><span class="line">|   +-- VTestB.vue</span><br><span class="line">|   +-- index.js</span><br><span class="line">+-- modules</span><br><span class="line">|   +-- C.vue</span><br></pre></td></tr></table></figure>
<p>components/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> VTestA <span class="keyword">from</span> <span class="string">'./VTestA'</span></span><br><span class="line"><span class="keyword">import</span> VTestB <span class="keyword">from</span> <span class="string">'./VTestB'</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  VTestA,</span><br><span class="line">  VTestB</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在C.vue里面输入VTestA，出现了VTestAVue提示,表示该组件：<br><img src="vscodeCfg/f9c1b2d4.png" alt=""><br><img src="/2019/05/12/vscodeCfg/f9c1b2d4.png"><br>选中之后，就自动从相应目录导入了这个单文件组件：<br><img src="vscodeCfg/1a56a951.png" alt=""><br><img src="/2019/05/12/vscodeCfg/1a56a951.png" title="This is an example image"><br>但是我们想要有一个统一的出口，把这两个组件整理到index中了，怎么从自动index中导出这个组件呢？<br>如下图，选择提示中的后一个选项，就会从index文件中导入该组件<br><img src="vscodeCfg/9512bd18.png" alt=""><br><img src="/2019/05/12/vscodeCfg/9512bd18.png"><br>但是这样引入的路径偶尔会出现错误。造成这个问题的原因是：当导入SFC的时候不能忽略<code>.vue</code>后缀，参考<a href="https://vuejs.github.io/vetur/FAQ.html#vetur-cannot-recognize-my-vue-component-import-such-as-import-comp-from-comp" target="_blank" rel="noopener">这里</a>。</p>
<p>这个组件<code>import</code>到<code>components/index.js</code>文件里的时候，路径的文件名没有写<code>.vue</code>扩展名，所以这里也无法自动的从<code>index.js</code>文件引入。如下加上扩展名就没有问题了。<br>components/index.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> VTestA <span class="keyword">from</span> <span class="string">'./VTestA.vue'</span></span><br><span class="line"><span class="keyword">import</span> VTestB <span class="keyword">from</span> <span class="string">'./VTestB.vue'</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  VTestA,</span><br><span class="line">  VTestB</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="ESLint相关配置"><a href="#ESLint相关配置" class="headerlink" title="ESLint相关配置"></a>ESLint相关配置</h3><p>安装完<a href="https://marketplace.visualstudio.com/items?itemName=dbaeumer.vscode-eslint" target="_blank" rel="noopener">ESLint</a>之后，并没有对<code>.vue</code>文件起作用。<br>我们打开 VS Code 配置文件修改一下配置，让ESLint支持的语言包括<code>.vue</code>文件。</p>
<ul>
<li>On Windows/Linux - File &gt; Preferences &gt; Settings</li>
<li>On macOS - Code &gt; Preferences &gt; Settings</li>
</ul>
<p>搜索<code>eslint.validate</code>,我们选择直接打开json文件进行编辑：<br><img src="vscodeCfg/d32f21ad.png" alt=""><br><img src="/2019/05/12/vscodeCfg/d32f21ad.png"><br>右上角也有一个按钮能直接打开：<br><img src="vscodeCfg/385f01cc.png" alt=""><br><img src="/2019/05/12/vscodeCfg/385f01cc.png"><br>在配置文件中添加如下配置<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"eslint.validate"</span>: [</span><br><span class="line">    <span class="string">"javascript"</span>,</span><br><span class="line">    <span class="string">"javascriptreact"</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"language"</span>: <span class="string">"vue"</span>,</span><br><span class="line">      <span class="attr">"autoFix"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置完成之后测试一下，在行末加个分号（ESLint推荐不使用分号），会出现红色波浪线提示。<br>注意上文配置中的<code>autoFix</code>，它用来自动修复有问题的写法，这个非常的方便。怎么样使用呢？<br>快捷键：</p>
<ul>
<li>On Windows/Linux - <code>Ctrl+shift+p</code></li>
<li>On macOS - <code>⇧⌘P</code></li>
</ul>
<p>打开命令面板，搜索一下eslint，可以看到这条<code>Fix all auto-fixable Problems</code>命令。回车执行一下，多余的分号就自动去掉了。常用的命令，VS Code会记录下来排在前列，后面使用打开命令面板就能看到了。<br><img src="vscodeCfg/8fb92872.png" alt=""><br><img src="/2019/05/12/vscodeCfg/8fb92872.png"></p>
<h3 id="lt-template-gt-校验"><a href="#lt-template-gt-校验" class="headerlink" title="&lt;template&gt; 校验"></a><code>&lt;template&gt;</code> 校验</h3><p>使用<code>iview</code>框架的时候，有一些组件会被标识语法错误。比如，这样使用<code>&lt;Col&gt;&lt;/Col&gt;</code>组件的时候，就会报错（由于html中<code>&lt;col/&gt;</code>是自闭合标签）。类似这种情况，我们想要修改模版的校验规则，要怎么做呢？<br>vetur支持对模版<code>&lt;template&gt;</code>进行校验，但是它内部使用的是一个固定版本的<code>eslint-plugin-vue</code>，并且不可配置。vetur官方给出的<a href="https://github.com/vuejs/vetur/blob/master/docs/linting-error.md#linting-for-template" target="_blank" rel="noopener">建议</a>是要关掉vetur的模版配置，自己安装<code>eslint-plugin-vue</code>。</p>
<ul>
<li>在配置中，设置vetur.validation.template: false，关掉vetur模版校验，使用ESLint的；</li>
<li>在项目中安装<code>eslint-plugin-vue</code>插件；</li>
<li>在<code>.eslintrc</code>文件中设置ESLint规则。</li>
</ul>
<p>比如刚才的<code>iview</code>组件的例子，配置如下：<br>.eslintrc<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"extends"</span>: [</span><br><span class="line">    <span class="string">"eslint:recommended"</span>,</span><br><span class="line">    <span class="string">"plugin:vue/recommended"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"rules"</span>: &#123;</span><br><span class="line">    <span class="attr">"vue/no-parsing-error"</span>: [</span><br><span class="line">       <span class="number">2</span>,</span><br><span class="line">      &#123;</span><br><span class="line">       <span class="attr">"x-invalid-end-tag"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="其他细节"><a href="#其他细节" class="headerlink" title="其他细节"></a>其他细节</h3><p>ESLint规则缩进是两个空格，但是VS Code默认的tab是4个空格，在配置中改成2个：<br><img src="vscodeCfg/cdf682cb.png" alt=""><br><img src="/2019/05/12/vscodeCfg/cdf682cb.png"></p>
<p>安装vue但文件组件的模版插件<a href="https://marketplace.visualstudio.com/items?itemName=sdras.vue-vscode-snippets#overview" target="_blank" rel="noopener"><code>Vue VSCode Snippets</code></a>，方便我们快速新建<code>.vue</code>文件。<br><img src="vscodeCfg/f3da3f53.png" alt=""><br><img src="/2019/05/12/vscodeCfg/f3da3f53.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/05/12/vscodeCfg/" data-id="ck47vuvz20000dl7vmw3xk1y0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/12/16/compileTemplate/">简易模板编译工具</a>
          </li>
        
          <li>
            <a href="/2019/07/17/miniWebpack/">webpack 打包过程</a>
          </li>
        
          <li>
            <a href="/2019/05/12/vscodeCfg/">Vue 项目的 VS Code 配置</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 xunxun@zhenmei.li<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>



    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>
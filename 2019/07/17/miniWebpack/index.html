<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>webpack 打包过程 | xunxun&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文参考webpack创始人 Tobias Koppers 的视频 Webpack founder Tobias Koppers demos bundling live by hand，学习了webpack打包过程。 手动打包文件文件目录我们准备一个极简单的项目来进行打包，目录结构和内容如下：12345+-- src| +-- big.js| +-- helloWorld.js| +-- inde">
<meta property="og:type" content="article">
<meta property="og:title" content="webpack 打包过程">
<meta property="og:url" content="http://yoursite.com/2019/07/17/miniWebpack/index.html">
<meta property="og:site_name" content="xunxun&#39;s Blog">
<meta property="og:description" content="本文参考webpack创始人 Tobias Koppers 的视频 Webpack founder Tobias Koppers demos bundling live by hand，学习了webpack打包过程。 手动打包文件文件目录我们准备一个极简单的项目来进行打包，目录结构和内容如下：12345+-- src| +-- big.js| +-- helloWorld.js| +-- inde">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/miniWebpack/5b4526ed.png">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/5b4526ed.png">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/miniWebpack/2019-07-28-00-18-44.png">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/2019-07-28-00-18-44.png">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/miniWebpack/2019-07-28-01-23-40.png">
<meta property="og:image" content="http://yoursite.com/2019/07/17/miniWebpack/2019-07-28-01-23-40.png">
<meta property="og:updated_time" content="2019-07-28T09:20:39.351Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="webpack 打包过程">
<meta name="twitter:description" content="本文参考webpack创始人 Tobias Koppers 的视频 Webpack founder Tobias Koppers demos bundling live by hand，学习了webpack打包过程。 手动打包文件文件目录我们准备一个极简单的项目来进行打包，目录结构和内容如下：12345+-- src| +-- big.js| +-- helloWorld.js| +-- inde">
<meta name="twitter:image" content="http://yoursite.com/2019/07/17/miniWebpack/miniWebpack/5b4526ed.png">
  
    <link rel="alternate" href="/atom.xml" title="xunxun&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">xunxun&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-miniWebpack" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/17/miniWebpack/" class="article-date">
  <time datetime="2019-07-17T15:56:56.000Z" itemprop="datePublished">2019-07-17</time>
</a>
    
</span>
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      webpack 打包过程
    </h1>
  

      </header>
      <div id="busuanzi_container_page_pv" style="left: 20px;display: inline;color: #ccc;font-size: 12px;position: relative;top: 6px;">
          本文总阅读量<span id="busuanzi_value_page_pv"></span>次</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文参考<code>webpack</code>创始人 Tobias Koppers 的视频 <a href="https://www.youtube.com/watch?v=UNMkLHzofQI" target="_blank" rel="noopener">Webpack founder Tobias Koppers demos bundling live by hand</a>，学习了<code>webpack</code>打包过程。</p>
<h1 id="手动打包文件"><a href="#手动打包文件" class="headerlink" title="手动打包文件"></a>手动打包文件</h1><h2 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h2><p>我们准备一个极简单的项目来进行打包，目录结构和内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+-- src</span><br><span class="line">| +-- big.js</span><br><span class="line">| +-- helloWorld.js</span><br><span class="line">| +-- index.js</span><br><span class="line">| +-- lazy.js</span><br></pre></td></tr></table></figure></p>
<p>index.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">'./helloWorld'</span></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line"><span class="keyword">import</span>(<span class="comment">/* webpackChunkName: "async" */</span> <span class="string">'./lazy'</span>).then(<span class="function">(<span class="params">&#123; <span class="keyword">default</span>: lazy &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">node.innerHTML = helloWorld + lazy</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(node)</span><br></pre></td></tr></table></figure></p>
<p>helloWorld.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"><span class="keyword">const</span> helloWorld = big(<span class="string">'hello world!'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> helloWorld</span><br></pre></td></tr></table></figure></p>
<p>big.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (val) =&gt; &#123;</span><br><span class="line"><span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>lazy.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> big <span class="keyword">from</span> <span class="string">'./big'</span></span><br><span class="line"><span class="keyword">const</span> lazy = big(<span class="string">"lazy loaded!"</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> lazy</span><br></pre></td></tr></table></figure></p>
<p>我们先来看下webpack打包之后的结果，省略了一些代码，但是大体可以看到，所有分散的文件最终变成一个立即执行函数，参数是文件（模块）队列数组。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/******/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>) </span>&#123;<span class="comment">// webpackBootstrap</span></span><br><span class="line">   <span class="comment">/******/</span> <span class="comment">// ...</span></span><br><span class="line"> <span class="comment">/******/</span> &#125;)(&#123;</span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/big.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;&#125;),</span><br><span class="line"><span class="comment">/***/</span> <span class="string">"./src/index.js"</span>:</span><br><span class="line"><span class="comment">/***/</span> (<span class="function"><span class="keyword">function</span>(<span class="params">module, __webpack_exports__, __webpack_require__</span>) </span>&#123;</span><br><span class="line"><span class="comment">/***/</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">/******/</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>我们的目标是通过人工打包的方式生成这样一个立即执行函数，通过一定的串联逻辑，将所有的模块整合到一起。</p>
<h2 id="模块划分"><a href="#模块划分" class="headerlink" title="模块划分"></a>模块划分</h2><p>可以看到项目模块之间有这样的引用关系，入口文件引入了<code>helloWorld</code>和<code>lazy</code>，<code>helloWorld</code>和<code>lazy</code>分别又引入了<code>big</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* src/index.js (ESM)</span><br><span class="line">    #  ./helloWorld</span><br><span class="line">    # (async) ./lazy</span><br><span class="line">    -  src/helloWorld.js</span><br><span class="line">    -  (async) src/lazy.js</span><br><span class="line">* src/helloWorld.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br><span class="line">* src/big.js</span><br><span class="line">* src/lazy.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br></pre></td></tr></table></figure>
<p> 打包之后将生成两个文件，一个主文件main.js，一个是动态引入的async.js。其中，main是async的父文件，main中有的模块，asycn可以不引入。main文件里面已经包含了<code>src/big.js</code>，这里进行优化，打包后的<code>async.js</code>不需要包含<code>src/big.js</code><br> 如下图所示：<br> <img src="miniWebpack/5b4526ed.png" alt=""><br><img src="/2019/07/17/miniWebpack/5b4526ed.png"></p>
<p> main.js<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- src/index.js</span><br><span class="line">- src/helloWorld.js</span><br><span class="line">- src/big.js</span><br></pre></td></tr></table></figure></p>
<p> async.js (parent:main)<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- src/lazy.js</span><br><span class="line">- src/big.js （ in parent）---delete</span><br></pre></td></tr></table></figure></p>
<p> 现在划分一下模块，可以看到入口文件–<code>index.js</code>，我们将它<code>import</code>的文件直接串联当成第一个模块。这里只有引入一个模块<code>helloWorld</code>（lazy是打包进去<code>async.js</code>暂不考虑）。由此可以划分成三个模块，我们手动为每个模块赋予一个<code>id</code>（中括号中的数字）。<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* [0]src/index.js (ESM) + 1modules</span><br><span class="line">    #  ./helloWorld</span><br><span class="line">    # (async) ./lazy</span><br><span class="line">    -  src/helloWorld.js</span><br><span class="line">    -  (async) src/lazy.js</span><br><span class="line">    -  src/big.js</span><br><span class="line">* [1]src/big.js</span><br><span class="line">* [2]src/lazy.js (ESM)</span><br><span class="line">    # ./big</span><br><span class="line">    -  src/big.js</span><br></pre></td></tr></table></figure></p>
<h2 id="import和export"><a href="#import和export" class="headerlink" title="import和export"></a>import和export</h2><p> 我们知道<code>webpack</code>把分散的代码通过<code>import</code>和<code>export</code>串成一个立即执行函数（IIFE），参数是模块对象数组。<br> 其中模块对象是一个这样的结构：<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">  [moduleId]: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 模块代码</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在来处理一下每个文件的<code>import</code>和<code>export</code> 。</p>
<p>对于每一个模块，要保证有独立的作用域，用一个<code>funtion</code>去包裹。并且传入两个参数，用来实现<code>import</code>和<code>export</code>的功能。<br> index.js + 1 modules(hellowWorld.js)<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> helloWorld = X.default(<span class="string">'hello world!'</span>)</span><br><span class="line">  <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">  node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">  <span class="comment">// 先看普通的import</span></span><br><span class="line">  <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;) =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   node.innerHTML = helloWorld + lazy</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>big.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">  exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="模拟import"><a href="#模拟import" class="headerlink" title="模拟import"></a>模拟import</h3><p> import的功能就是：<br> 1.执行目标模块的代码;<br> 2.导出目标模块的<code>export</code>内容给外部使用。<br> 如下<code>__require__</code>函数的实现，<br> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__require__</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 设置一个缓存，有的话直接返回</span></span><br><span class="line">    <span class="keyword">if</span>(cache[id]) <span class="keyword">return</span> cache[id].exports</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">        exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 1、执行当前模块的内容，这个modules[id]就是我们刚才对每个模块封装的那个方法</span></span><br><span class="line">    modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>)</span><br><span class="line">    cache[id] = <span class="built_in">module</span></span><br><span class="line">    <span class="comment">// 2、导出当前模块的export内容给外部使用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="built_in">module</span> = &#123;</span><br><span class="line">            exports: []</span><br><span class="line">        &#125;</span><br><span class="line">        modules[id](__require__, <span class="built_in">module</span>.exports, <span class="built_in">module</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">module</span>.exports</span><br><span class="line">    &#125;</span><br><span class="line">    __require__(<span class="number">0</span>)</span><br><span class="line">    &#125;)(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">0</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">const</span> helloWorld = X.default(<span class="string">'hello world!'</span>)</span><br><span class="line">                <span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">                node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line">                <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;)   =&gt; &#123;</span></span><br><span class="line">                <span class="comment">// node.innerHTML = helloWorld + lazy</span></span><br><span class="line">                <span class="comment">// &#125;</span></span><br><span class="line">                <span class="built_in">document</span>.body.appendChild(node)</span><br><span class="line">              &#125;),</span><br><span class="line">        <span class="number">1</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">                exports.default = <span class="function">(<span class="params">val</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> val &amp;&amp; val.toUpperCase()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>在index.html上引入这个文件，打开就能看到结果了。至此，我们完成了最基本的手动打包流程。</p>
<h3 id="懒加载模块"><a href="#懒加载模块" class="headerlink" title="懒加载模块"></a>懒加载模块</h3><p>现在还剩下对<code>lazy.js</code>的打包，它是作为一个单独的文件，按需引入的。我们希望使用的时候是这样的，加载完模块，然后进行require：<br>index.js (bundled)<br>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default: lazy &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="comment">// node.innerHTML = helloWorld + lazy</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">__require__.loadChunk(<span class="number">0</span>)</span><br><span class="line">    .then(__require__.bind(<span class="literal">null</span>, <span class="number">3</span>))</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span>(<span class="params">Y</span>)</span>&#123;</span><br><span class="line">            node.innerHTML = helloWorld + Y.default</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure></p>
<p>请求一个文件地址，得到文件中的数据，这个过程用类似<code>jsonp</code>的方式来实现。<br><img src="miniWebpack/2019-07-28-00-18-44.png" alt=""><br><img src="/2019/07/17/miniWebpack/2019-07-28-00-18-44.png"></p>
<p>首先是下载文件，这个过程是异步的，要用一个<code>promise</code>来封装。下载完成，还需要解析出数据才能执行下一步。所以，<code>promise</code>的回调函数<code>resolve</code>下载完成先放在一个全局变量<code>chunkResolves</code>当中，等解析出数据之后再调用它。</p>
<p>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个模块下载(promise)完成对应的resolve</span></span><br><span class="line"><span class="keyword">let</span> chunkResolves = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">__require__.loadChunk = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        chunkResolves[chunkId] = resolve</span><br><span class="line">        <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">        script.src = <span class="string">'src/'</span> + &#123;<span class="number">0</span>: <span class="string">'async'</span>&#125;[chunkId]+ <span class="string">'.js'</span></span><br><span class="line">        <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>根据<code>jsonp</code>的原理，下载下来的模块对象需要用一个<code>callback</code>（这里是<code>requireJsonp</code>）包裹，变成一个可执行的脚本，下载完成之后在本地执行这个<code>callback</code>才能解析出模块对象。所以手动对异步的模块进行一个封装：<br>async.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.requireJsonp( <span class="number">0</span>, &#123;</span><br><span class="line">    <span class="number">3</span>: (<span class="function"><span class="keyword">function</span>(<span class="params">__require__, exports</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> X = __require__(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">const</span> lazy = X.default(<span class="string">"lazy loaded!"</span>)</span><br><span class="line">        exports.default = lazy</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>并且我们应提前声明好<code>window.requireJsonp</code>这个回调函数。我们把下载得到的动态模块对象添加到立即执行函数参数的个模块对象，就回到了普通的模块打包的情况，这时候解析完成，执行<code>promise</code>的<code>resolve</code>，算是整个异步加载的过程结束。<br>runtime.js<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">!(<span class="function"><span class="keyword">function</span>(<span class="params">modules</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__require__</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">     <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 每个模块下载(promise)完成对应的resolve</span></span><br><span class="line">   <span class="keyword">let</span> chunkResolves = &#123;&#125;;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">window</span>.requireJsonp = <span class="function"><span class="keyword">function</span>(<span class="params">chunkId, newModules</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> id <span class="keyword">in</span> newModules) &#123;</span><br><span class="line">            modules[id] = newModules[id]</span><br><span class="line">            chunkResolves[chunkId]();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __require__(<span class="number">0</span>)</span><br><span class="line">    &#125;)(&#123;</span><br><span class="line">        <span class="comment">//...模块对象</span></span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure></p>
<p>这样，我们就完成了人工打包一个项目的简单流程。接下来看要怎么用代码来实现自动打包。</p>
<h1 id="自动打包"><a href="#自动打包" class="headerlink" title="自动打包"></a>自动打包</h1><p>我们参考开源项目<a href="https://github.com/ronami/minipack" target="_blank" rel="noopener">minipack</a>，来看看要怎么实现一个简易的打包工具。<br>先不看详细的细节，我们主要的步骤就是:<br> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解析模块</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span>(<span class="params">filename</span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 生成依赖图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span>(<span class="params">entry</span>)</span>&#123;&#125;</span><br><span class="line"><span class="comment">// 打包</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span>(<span class="params">graph</span>)</span>&#123;&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> graph = createGraph(<span class="string">'./src/index.js'</span>)</span><br><span class="line"><span class="keyword">const</span> result = bundle(graph)</span><br></pre></td></tr></table></figure></p>
<p> 所依赖的工具</p>
<ul>
<li>abylon：js解析器，将文本代码转化成AST（语法树）</li>
<li>babel-travse：遍历AST寻找依赖关系</li>
<li>babel-core的transformFromAst：将AST代码转化成浏览器所能识别的代码(ES5)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> babylon = <span class="built_in">require</span>(<span class="string">'babylon'</span>); <span class="comment">// 将文件转化成AST</span></span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'babel-traverse'</span>).default; <span class="comment">// 寻找依赖关系</span></span><br><span class="line"><span class="keyword">const</span> &#123;transformFromAst&#125; = <span class="built_in">require</span>(<span class="string">'babel-core'</span>); <span class="comment">// 将 AST 转化成 ES5</span></span><br></pre></td></tr></table></figure>
<p> 主要就是把文本文件转化成语法树，拿到<code>import</code>和<code>export</code>知道模块之间的依赖关系，再把语法树转换成ES5。</p>
<p>可以了解一下语法树,如下图所示，可以拿到每句代码对应的信息。<br><img src="miniWebpack/2019-07-28-01-23-40.png" alt=""><br><img src="/2019/07/17/miniWebpack/2019-07-28-01-23-40.png"></p>
<h2 id="解析单个文件"><a href="#解析单个文件" class="headerlink" title="解析单个文件"></a>解析单个文件</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createAsset</span>(<span class="params">filename</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 读一个文件，得到一个文件内容的字符串</span></span><br><span class="line">  <span class="keyword">const</span> content = fs.readFileSync(filename, <span class="string">'utf-8'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 我们通过 babylon 这个 javascript 解析器来理解 import 进来的字符串</span></span><br><span class="line">  <span class="keyword">const</span> ast = babylon.parse(content, &#123;</span><br><span class="line">    sourceType: <span class="string">'module'</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 该模块所依赖的模块的相对路径放在这个 dependencies 数组</span></span><br><span class="line">  <span class="keyword">const</span> dependencies = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// import声明</span></span><br><span class="line">  traverse(ast, &#123;</span><br><span class="line">    <span class="comment">// es6 的模块是静态的，不能导入一个变量或者有条件的导入另一个模块</span></span><br><span class="line">    ImportDeclaration: <span class="function">(<span class="params">&#123;node&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 所依赖的模块的路径</span></span><br><span class="line">      dependencies.push(node.source.value);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递增设置模块ID</span></span><br><span class="line">  <span class="keyword">const</span> id = ID++;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AST -&gt; ES5</span></span><br><span class="line">  <span class="keyword">const</span> &#123;code&#125; = transformFromAst(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">    presets: [<span class="string">'env'</span>],</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 返回模块的信息</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    id,</span><br><span class="line">    filename,</span><br><span class="line">    dependencies,</span><br><span class="line">    code,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index文件解析后输出如下内容<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> helloWorld <span class="keyword">from</span> <span class="string">'./helloWorld'</span></span><br><span class="line"><span class="keyword">const</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>)</span><br><span class="line">node.innerHTML = helloWorld + <span class="string">'loading...'</span></span><br><span class="line"><span class="built_in">document</span>.body.appendChild(node)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">  filename: <span class="string">'./src/index.js'</span>,</span><br><span class="line">  dependencies: [ <span class="string">'./helloWorld.js'</span> ],</span><br><span class="line">  code: <span class="string">'"use strict";\n\n</span></span><br><span class="line"><span class="string">    var _helloWorld = require("./helloWorld.js");\n\n</span></span><br><span class="line"><span class="string">    var _helloWorld2 = _interopRequireDefault(_helloWorld);\n\n</span></span><br><span class="line"><span class="string">    function  _interopRequireDefault(obj) &#123; </span></span><br><span class="line"><span class="string">        return obj &amp;&amp; obj.__esModule ? obj : &#123;</span></span><br><span class="line"><span class="string">        default: obj &#125;; &#125;\n\n</span></span><br><span class="line"><span class="string">    var node = document.createElement("div");\nn</span></span><br><span class="line"><span class="string">    ode.innerHTML = _helloWorld2.default + \'loading...\';\n\n</span></span><br><span class="line"><span class="string">    document.body.appendChild(node);'</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="生成依赖图"><a href="#生成依赖图" class="headerlink" title="生成依赖图"></a>生成依赖图</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们需要知道单个模块的依赖，然后从入口文件开始，提取依赖图</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGraph</span>(<span class="params">entry</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 从第一个文件开始,首先解析index文件</span></span><br><span class="line">  <span class="keyword">const</span> mainAsset = createAsset(entry);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义一个依赖队列，一开始的时候只有入口文件</span></span><br><span class="line">  <span class="keyword">const</span> queue = [mainAsset];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 queue，广度优先</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> asset <span class="keyword">of</span> queue) &#123;</span><br><span class="line">    asset.mapping = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dirname = path.dirname(asset.filename);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历依赖数组，解析每一个依赖模块</span></span><br><span class="line">    asset.dependencies.forEach(<span class="function"><span class="params">relativePath</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> absolutePath = path.join(dirname, relativePath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析</span></span><br><span class="line">      <span class="keyword">const</span> child = createAsset(absolutePath);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 子模块`路径-id`map</span></span><br><span class="line">      asset.mapping[relativePath] = child.id;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 每一个子模块加入依赖图队列，进行遍历</span></span><br><span class="line">      queue.push(child);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>输出的依赖图长这样：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[ &#123; <span class="attr">id</span>: <span class="number">0</span>,</span><br><span class="line">    filename: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    dependencies: [ <span class="string">'./helloWorld.js'</span> ],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nvar _helloWorld = require("./helloWorld.js");\n\nvar _helloWorld2 = _interopRequireDefault(_helloWorld);\n\nfunction _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;\n\nvar node = document.createElement("div");\nnode.innerHTML = _helloWorld2.default + \'loading...\';\n// import(/* webpackChunkName: "async" */ \'./lazy\').then((&#123; default: lazy &#125;) =&gt; &#123;\n//   node.innerHTML = helloWorld + lazy\n// &#125;)\ndocument.body.appendChild(node);'</span>,</span><br><span class="line">    mapping: &#123; <span class="string">'./helloWorld.js'</span>: <span class="number">1</span> &#125;</span><br><span class="line">   &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    filename: <span class="string">'src\\helloWorld.js'</span>,</span><br><span class="line">    dependencies: [ <span class="string">'./big.js'</span> ],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nObject.defineProperty(exports, "__esModule", &#123;\n  value: true\n&#125;);\n\nvar _big = require("./big.js");\n\nvar _big2 = _interopRequireDefault(_big);\n\nfunction _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;\n\nvar helloWorld = (0, _big2.default)(\'hello world!\');\nexports.default = helloWorld;'</span>,</span><br><span class="line">    mapping: &#123; <span class="string">'./big.js'</span>: <span class="number">2</span> &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    filename: <span class="string">'src\\big.js'</span>,</span><br><span class="line">    dependencies: [],</span><br><span class="line">    code:</span><br><span class="line">     <span class="string">'"use strict";\n\nObject.defineProperty(exports, "__esModule", &#123;\n  value: true\n&#125;);\n\nexports.default = function (val) &#123;\n  return val &amp;&amp; val.toUpperCase();\n&#125;;'</span>,</span><br><span class="line">    mapping: &#123;&#125;</span><br><span class="line">  &#125; ]</span><br></pre></td></tr></table></figure></p>
<h2 id="构造自执行函数和参数modules"><a href="#构造自执行函数和参数modules" class="headerlink" title="构造自执行函数和参数modules"></a>构造自执行函数和参数<code>modules</code></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最终我们要生成一个自执行函数，参数是模块依赖图</span></span><br><span class="line"><span class="comment">// (function() &#123;&#125;)()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bundle</span>(<span class="params">graph</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> modules = <span class="string">''</span>;</span><br><span class="line">  graph.forEach(<span class="function"><span class="params">mod</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 利用 createAsset 解析的时候，我们是把 import 转化成 commonJs 的 require</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模块`id-路径`的map，因为我们转化之后的代码的require是使用相对路径.写一个map，拿到模块id的时候可以知道该模块对应的路径</span></span><br><span class="line">    <span class="comment">// &#123; './relative/path': 1 &#125;.</span></span><br><span class="line"></span><br><span class="line">    modules += <span class="string">`<span class="subst">$&#123;mod.id&#125;</span>: [</span></span><br><span class="line"><span class="string">      function (require, module, exports) &#123;</span></span><br><span class="line"><span class="string">        <span class="subst">$&#123;mod.code&#125;</span></span></span><br><span class="line"><span class="string">      &#125;,</span></span><br><span class="line"><span class="string">      <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(mod.mapping)&#125;</span>,</span></span><br><span class="line"><span class="string">    ],`</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> result = <span class="string">`</span></span><br><span class="line"><span class="string">    (function(modules) &#123;</span></span><br><span class="line"><span class="string">      function require(id) &#123;</span></span><br><span class="line"><span class="string">        const [fn, mapping] = modules[id];</span></span><br><span class="line"><span class="string">        function localRequire(name) &#123;</span></span><br><span class="line"><span class="string">          return require(mapping[name]);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        const module = &#123; exports : &#123;&#125; &#125;;</span></span><br><span class="line"><span class="string">        fn(localRequire, module, module.exports);</span></span><br><span class="line"><span class="string">        return module.exports;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      require(0);</span></span><br><span class="line"><span class="string">    &#125;)(&#123;<span class="subst">$&#123;modules&#125;</span>&#125;)</span></span><br><span class="line"><span class="string">  `</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的模块对象参数跟我们第一部分手动打包的模块对像是一样的：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _helloWorld = <span class="built_in">require</span>(<span class="string">"./helloWorld.js"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _helloWorld2 = _interopRequireDefault(_helloWorld);</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> node = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">        node.innerHTML = _helloWorld2.default + <span class="string">'loading...'</span>;</span><br><span class="line">        <span class="comment">// import(/* webpackChunkName: "async" */ './lazy').then((&#123; default:</span></span><br><span class="line">        lazy &#125;) =&gt; &#123;</span><br><span class="line">        <span class="comment">//   node.innerHTML = helloWorld + lazy</span></span><br><span class="line">        <span class="comment">// &#125;)</span></span><br><span class="line">        <span class="built_in">document</span>.body.appendChild(node);</span><br><span class="line">              &#125;,</span><br><span class="line">     &#123;<span class="string">"./helloWorld.js"</span>:<span class="number">1</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line"><span class="number">1</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">          value: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _big = <span class="built_in">require</span>(<span class="string">"./big.js"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> _big2 = _interopRequireDefault(_big);</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">_interopRequireDefault</span>(<span class="params">obj</span>) </span>&#123; <span class="keyword">return</span> obj &amp;&amp; obj.__esModule ? obj : &#123; <span class="attr">default</span>: obj &#125;; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> helloWorld = (<span class="number">0</span>, _big2.default)(<span class="string">'hello world!'</span>);</span><br><span class="line">        exports.default = helloWorld;</span><br><span class="line">              &#125;,</span><br><span class="line">     &#123;<span class="string">"./big.js"</span>:<span class="number">2</span>&#125;,</span><br><span class="line">    ],</span><br><span class="line"><span class="number">2</span>: [</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">require, module, exports</span>) </span>&#123;</span><br><span class="line"><span class="meta">        "use strict"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(exports, <span class="string">"__esModule"</span>, &#123;</span><br><span class="line">          value: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        exports.default = <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> val &amp;&amp; val.toUpperCase();</span><br><span class="line">        &#125;;</span><br><span class="line">              &#125;,</span><br><span class="line">        &#123;&#125;,</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></p>
<p>至此我们完成了一个简易的模块打包器。</p>
<p>参考文献：<br><a href="https://www.youtube.com/watch?v=UNMkLHzofQI" target="_blank" rel="noopener">Webpack founder Tobias Koppers demos bundling live by hand</a><br>github 项目 <a href="https://github.com/ronami/minipack" target="_blank" rel="noopener">minipack</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/07/17/miniWebpack/" data-id="cjymrecsj0001c57vmh2t75zl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/05/12/vscodeCfg/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Vue 项目的 VS Code 配置</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/17/miniWebpack/">webpack 打包过程</a>
          </li>
        
          <li>
            <a href="/2019/05/12/vscodeCfg/">Vue 项目的 VS Code 配置</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 xunxun@zhenmei.li<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>



    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>